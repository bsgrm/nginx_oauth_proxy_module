# OAuth Proxy Module - Development

## 1. Intellisense Setup

Development IDEs expect to find OpenSSL headers in system locations, in order for intellisense to work.\
To enable this you can build the OpenSSL code from source: 

```bash
./development/openssl_setup.sh
```

Standard system locations will then be updated, for an improved developer experience:

```text
/usr/local/include/openssl/*
/usr/local/lib/libcrypto*
/usr/local/lib/libssl*
/usr/local/bin/openssl
```

## 2. Configure

Then run the base configure script as follows, to download NGINX source and point it to the OpenSSL location:

```bash
CONFIG_OPTS='--with-openssl=../openssl-OpenSSL_1_1_1m' ./configure 
```

Select these options to enable Perl tests to run and to enable debugging of the C code in an IDE such as CLion:

```text
DYNAMIC_MODULE=n
NGINX_DEBUG=y
```

## 3. Make

Whenever the code in the module changes, run the make command to rebuild NGINX:

```bash
./make
```

## 4. Make Install

Next run this to deploy the built NGINX system locally:

```bash
sudo make install
```

The `/usr/local/nginx` location will then be updated with a full NGINX installation.

## 5. Run NGINX Locally

Deploy the development `nginx.conf` file, then start NGINX locally:

```bash
sudo cp ./development/dev_nginx.conf /usr/local/nginx/conf/
sudo /usr/local/nginx/sbin/nginx
```

This nginx.conf file disables the daemon and runs NGINX interactively, so that logs are easily viewable.

## 6. Act as an SPA Client

During development, run curl requests in the same way as the SPA:

```bash
AT_COOKIE='093d3fb879767f6ec2b1e7e359040fe6ba875734ee043c5cc484d3da8963a351e9aba1c5e273f3d1ea2914f83836fa434474d1720b3040f5f7237f34536b7389'
curl -X GET http://localhost:8080/api \
-H "origin: https://www.example.com" \
-H "cookie: example-at=$AT_COOKIE"
```

```bash
AT_COOKIE='093d3fb879767f6ec2b1e7e359040fe6ba875734ee043c5cc484d3da8963a351e9aba1c5e273f3d1ea2914f83836fa434474d1720b3040f5f7237f34536b7389'
CSRF_HEADER='pQguFsD6hFjnyYjaeC5KyijcWS6AvkJHiUmY7dLUsuTKsLAITLiJHVqsCdQpaGYO'
CSRF_COOKIE='f61b300a79018b4b94f480086d63395148084af1f20c3e474623e60f34a181656b3a54725c1b4ddaeec9171f0398bde8c6c1e0e12d90bdb13397bf24678cd17a230a3df8e1771f9992e3bf2d6567ad920e1c25dc5e3e015679b5e673'
curl -X POST http://localhost:8080/api \
-H "origin: https://www.example.com" \
-H "x-example-csrf: $CSRF_HEADER" \
-H "cookie: example-at=$AT_COOKIE; example-csrf=$CSRF_COOKIE"
```

Calls are routed to an internet mockbin API that echoes headers and shows the forwarded token:

```json
{
  "method": "GET"
  "headers": {
    "host": "mockbin.org",
    "origin": "https://www.example.com",
    "cookie": "example-at=093d3fb879767f6ec2b1e7e359040fe6ba875734ee043c5cc484d3da8963a351e9aba1c5e273f3d1ea2914f83836fa434474d1720b3040f5f7237f34536b7389",
    "authorization": "Bearer 42665300-efe8-419d-be52-07b53e208f46",
  }
}
```

Failed requests due to invalid cookies etc return CORS headers so that the SPA can read the response:

```text
```

## 7. Debugging

The code can be imported into CLion 2020.2 or newer as a Makefile project.\ 
To do this though, you need to run the `configure` script _without_ running `make` or `make all`.\
Do not set the clean target since this deletes the Makefile, which is generated by the `configure` script.\
If this process is followed, the project will import easily and all the smart IDE features will work.\
Once nginx is running, select  `Run / Attach to Process`, then set breakpoints.\
Then send curl requests to NGINX and step through the module's code:

SCREENSHOT

Alternatively you can use a simple IDE such as Visual Studio Code with the C/C++ Extension Pack.\
To perform simple printf debugging you can add `ngx_log_error` to the C code and then look at NGINX output. 

## 8. Check for Memory Leaks

TODO: valgrind